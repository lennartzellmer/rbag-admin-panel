# Docker Development Environment

This directory contains the Docker configuration for the development environment.
It also contains the Terraform configuration for the IdP, Zitadel.

## TL;DR - Quick start

1. Copy `.env.example` to `.env` in the project root with:  
   `cp .env.example .env`
2. From the project root, run:  
   `docker-compose --env-file .env -f dev_docker/docker-compose.yml up -d`
3. Run the Terraform config for Zitadel:  
   `cd dev_docker/terraform && terraform init && terraform apply && terraform output -json`
4. Take the output from the previous Terraform step and add it to the `.env` file.
5. From the project root, install the dependencies:  
   `pnpm install`
6. From the project root, start the Nuxt application:  
   `pnpm dev`
7. Access the application at:  
   <http://0.0.0.0:3001>

---

## Services

The development environment needs the following services:

1. **MongoDB** - Database with replica set configuration for the Nuxt app  
   <http://localhost:27017>
2. **MinIO** - S3-compatible object storage  
   UI: <http://localhost:9001> (See .env for credentials)  
   API: <http://localhost:9000>
3. **Zitadel** - Identity and access management  
   <http://localhost:8080/ui/console/>
4. **Zitadel Login** - Login UI for Zitadel  
   <http://localhost:3000/ui/v2/login>
5. **MailHog** - Mail catcher for testing email sends  
   UI: <http://localhost:8035>  
   SMTP: <http://localhost:1025>
6. **Zitadel Database** - PostgreSQL database for Zitadel  
   <http://localhost:5432>

### Environment Variables

Some configuration and secrets need to be shared between the Nuxt application and Docker environment.
The `.env` file in the project root stores this information in a central place. Some variables are also generated by the Terraform configuration for the Zitadel instance; add those to the `.env` file.

## Usage

### Starting the Docker services

When starting the Docker services, you need to reference the `.env` file. To do so, include it in the command as follows:

```bash
# From the project root
docker-compose --env-file .env -f dev_docker/docker-compose.yml up -d

# From the dev_docker directory
docker-compose --env-file ../.env up -d
```

### Stopping the Development Environment

```bash
# From the dev_docker directory
docker-compose down

# To also remove volumes (WARNING: This will delete all data)
docker-compose down -v
```

## Troubleshooting

### MongoDB Replica Set

MongoDB initializes a replica set on launch. This is needed to utilize transactional write operations for the event store.
If it fails to do so, create the replica set config like this:

```bash
# Connect to MongoDB container
docker exec -it mongodb mongosh

# Use admin database
use admin

# Promote to root (with password from .env)
db.auth("root", "root")

# Initialize replica set
rs.initiate({ _id: "rs0", members: [{ _id: 0, host: "localhost:27017" }]})
```

### Zitadel Setup

Zitadel will initialize on first run. The setup process may take a few minutes. You can monitor the progress with:

```bash
docker-compose logs -f zitadel
```

When the Docker container has started, run the Zitadel Terraform configuration. This sets up all necessary settings, actions, projects, secrets, and application clients to use the Nuxt app together with Zitadel.
The Terraform config lives in `dev_docker/terraform/main.tf` and expects a ZITADEL service account JSON at `dev_docker/zitadel/key-service-user.json` as well as a personal access token at `dev_docker/zitadel/pat-admin.pat`. The `key-service-user.json` and `pat-admin.pat` files will be created automatically on Zitadel's first start.

#### Apply the Terraform config

```bash
cd dev_docker/terraform
terraform init
terraform apply
```

You can access the admin UI of Zitadel via:

- **Console**: <http://localhost:8080/ui/console/>
- **Username**: <admin@rbag.localhost>
- **Password**: `Password1!`

### MinIO Access

- **Console**: <http://localhost:9001>
- **API**: <http://localhost:9000>
- **Credentials**: see .env file
